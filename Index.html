<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Game Đánh Quái 3D - Di Chuyển Tự Do</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            touch-action: none;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #000;
            color: #fff;
            overflow: hidden;
            width: 100vw;
            height: 100vh;
            position: fixed;
        }
        
        #gameContainer {
            width: 100%;
            height: 100%;
            position: relative;
        }
        
        canvas {
            display: block;
            outline: none;
        }
        
        /* UI Overlay */
        .ui-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }
        
        /* Thông tin người chơi */
        .player-info {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #3498db;
            pointer-events: auto;
            min-width: 200px;
        }
        
        .player-info h3 {
            color: #3498db;
            margin-bottom: 10px;
            font-size: 1.2rem;
        }
        
        .stat-bar {
            height: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            margin: 8px 0;
            overflow: hidden;
            position: relative;
        }
        
        .health-bar {
            background: linear-gradient(to right, #e74c3c, #2ecc71);
            height: 100%;
            transition: width 0.3s ease;
        }
        
        .mana-bar {
            background: linear-gradient(to right, #2980b9, #3498db);
            height: 100%;
            transition: width 0.3s ease;
        }
        
        .bar-text {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85rem;
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
        }
        
        /* Điều khiển di chuyển */
        .movement-controls {
            position: absolute;
            bottom: 120px;
            left: 20px;
            width: 160px;
            height: 160px;
            pointer-events: auto;
        }
        
        .joystick-base {
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.3);
            position: relative;
        }
        
        .joystick-handle {
            width: 60px;
            height: 60px;
            background: rgba(52, 152, 219, 0.8);
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border: 2px solid rgba(255, 255, 255, 0.5);
            cursor: move;
        }
        
        /* Điều khiển chiến đấu */
        .combat-controls {
            position: absolute;
            bottom: 120px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            pointer-events: auto;
        }
        
        .combat-btn {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: none;
            color: white;
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            user-select: none;
        }
        
        .combat-btn:active {
            transform: scale(0.9);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }
        
        .attack-btn {
            background: linear-gradient(to bottom, #e74c3c, #c0392b);
        }
        
        .magic-btn {
            background: linear-gradient(to bottom, #9b59b6, #8e44ad);
        }
        
        .jump-btn {
            background: linear-gradient(to bottom, #2ecc71, #27ae60);
        }
        
        /* Mini map */
        .mini-map {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 150px;
            height: 150px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 10px;
            border: 2px solid #2ecc71;
            overflow: hidden;
            pointer-events: auto;
        }
        
        .mini-map-canvas {
            width: 100%;
            height: 100%;
        }
        
        /* Thông báo */
        .notification {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 20px 30px;
            border-radius: 10px;
            border: 3px solid #ff9a00;
            text-align: center;
            max-width: 80%;
            z-index: 20;
            display: none;
        }
        
        .notification h2 {
            color: #ff9a00;
            margin-bottom: 10px;
            font-size: 1.8rem;
        }
        
        .restart-btn {
            background: linear-gradient(to bottom, #ff9a00, #ff6f00);
            border: none;
            color: white;
            padding: 12px 25px;
            font-size: 1rem;
            font-weight: bold;
            border-radius: 25px;
            cursor: pointer;
            margin-top: 15px;
        }
        
        /* Thanh công cụ */
        .toolbar {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            pointer-events: auto;
        }
        
        .toolbar-btn {
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid #3498db;
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }
        
        .toolbar-btn:active {
            background: rgba(52, 152, 219, 0.3);
        }
        
        /* Hướng dẫn */
        .instructions {
            position: absolute;
            bottom: 20px;
            left: 200px;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border-radius: 8px;
            font-size: 0.8rem;
            color: #ccc;
            max-width: 250px;
            pointer-events: auto;
        }
        
        /* Loading screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }
        
        .loading-bar-container {
            width: 300px;
            height: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            margin-top: 20px;
            overflow: hidden;
        }
        
        .loading-bar {
            height: 100%;
            background: linear-gradient(to right, #3498db, #2ecc71);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        /* Cho desktop */
        @media (min-width: 768px) {
            .joystick-base {
                width: 120px;
                height: 120px;
            }
            
            .joystick-handle {
                width: 50px;
                height: 50px;
            }
            
            .combat-btn {
                width: 70px;
                height: 70px;
            }
        }
        
        /* Hiệu ứng damage */
        .damage-effect {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(231, 76, 60, 0.3);
            z-index: 5;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.min.js"></script>
</head>
<body>
    <div id="gameContainer"></div>
    
    <div class="loading-screen" id="loadingScreen">
        <h2>Đang tải Game Đánh Quái 3D...</h2>
        <div class="loading-bar-container">
            <div class="loading-bar" id="loadingBar"></div>
        </div>
        <p id="loadingText">Khởi tạo thế giới 3D...</p>
    </div>
    
    <div class="ui-overlay">
        <div class="player-info">
            <h3>NHÂN VẬT</h3>
            <div>HP: <span id="hpText">100/100</span></div>
            <div class="stat-bar">
                <div class="health-bar" id="healthBar"></div>
                <div class="bar-text" id="healthText">100/100</div>
            </div>
            <div>Mana: <span id="manaText">50/50</span></div>
            <div class="stat-bar">
                <div class="mana-bar" id="manaBar"></div>
                <div class="bar-text" id="manaText">50/50</div>
            </div>
            <div>Cấp: <span id="levelText">1</span></div>
            <div>Vàng: <span id="goldText">0</span></div>
            <div>Quái vật: <span id="killText">0</span></div>
        </div>
        
        <div class="movement-controls" id="movementControls">
            <div class="joystick-base">
                <div class="joystick-handle" id="joystickHandle"></div>
            </div>
        </div>
        
        <div class="combat-controls">
            <button class="combat-btn jump-btn" id="jumpBtn">↑</button>
            <div style="display: flex; gap: 15px;">
                <button class="combat-btn magic-btn" id="magicBtn">✨</button>
                <button class="combat-btn attack-btn" id="attackBtn">⚔️</button>
            </div>
        </div>
        
        <div class="mini-map">
            <canvas class="mini-map-canvas" id="miniMapCanvas" width="150" height="150"></canvas>
        </div>
        
        <div class="toolbar">
            <button class="toolbar-btn" id="healBtn">Hồi phục (H)</button>
            <button class="toolbar-btn" id="nextEnemyBtn">Quái tiếp (N)</button>
            <button class="toolbar-btn" id="toggleSoundBtn">Âm thanh: Bật</button>
        </div>
        
        <div class="instructions">
            <strong>Điều khiển:</strong><br>
            • Kéo joystick để di chuyển<br>
            • Chạm nút để tấn công/nhảy<br>
            • Desktop: WASD để di chuyển, Space nhảy, Click chuột tấn công
        </div>
        
        <div class="notification" id="notification">
            <h2 id="notificationTitle">Thông báo</h2>
            <p id="notificationText"></p>
            <button class="restart-btn" id="restartBtn">Chơi lại</button>
        </div>
        
        <div class="damage-effect" id="damageEffect"></div>
    </div>

    <script>
        // Các biến toàn cục
        let scene, camera, renderer, controls;
        let player, enemies = [];
        let terrain, skybox;
        let clock = new THREE.Clock();
        let keys = {};
        let joystickActive = false;
        let joystickVector = new THREE.Vector2();
        
        // Trạng thái game
        let gameState = {
            player: {
                hp: 100,
                maxHP: 100,
                mana: 50,
                maxMana: 50,
                level: 1,
                gold: 0,
                kills: 0,
                exp: 0,
                expToNextLevel: 100,
                damage: 15,
                magicDamage: 25,
                speed: 5
            },
            enemies: [],
            gameOver: false,
            soundEnabled: true
        };
        
        // Tải assets
        let assetsLoaded = 0;
        let totalAssets = 10;
        
        // Khởi tạo game
        function init() {
            // Tạo scene
            scene = new THREE.Scene();
            scene.fog = new THREE.Fog(0x87ceeb, 10, 100);
            
            // Tạo camera
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 10, 20);
            
            // Tạo renderer
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            document.getElementById('gameContainer').appendChild(renderer.domElement);
            
            // Thêm ánh sáng
            addLighting();
            
            // Tạo terrain
            createTerrain();
            
            // Tạo skybox
            createSkybox();
            
            // Tạo player
            createPlayer();
            
            // Tạo quái vật ban đầu
            for (let i = 0; i < 5; i++) {
                createEnemy();
            }
            
            // Tạo items
            createItems();
            
            // Thêm điều khiển
            setupControls();
            
            // Thêm sự kiện
            setupEventListeners();
            
            // Bắt đầu game loop
            animate();
            
            // Ẩn loading screen
            setTimeout(() => {
                document.getElementById('loadingScreen').style.display = 'none';
                showNotification("Game Đánh Quái 3D", "Di chuyển và tiêu diệt quái vật!");
            }, 500);
        }
        
        // Thêm ánh sáng
        function addLighting() {
            updateLoading("Đang thêm ánh sáng...");
            
            // Ánh sáng mặt trời
            const sunLight = new THREE.DirectionalLight(0xffffff, 1);
            sunLight.position.set(50, 50, 50);
            sunLight.castShadow = true;
            sunLight.shadow.camera.left = -50;
            sunLight.shadow.camera.right = 50;
            sunLight.shadow.camera.top = 50;
            sunLight.shadow.camera.bottom = -50;
            sunLight.shadow.mapSize.width = 2048;
            sunLight.shadow.mapSize.height = 2048;
            scene.add(sunLight);
            
            // Ánh sáng môi trường
            const ambientLight = new THREE.AmbientLight(0x404040, 0.5);
            scene.add(ambientLight);
            
            assetsLoaded++;
            updateLoadingBar();
        }
        
        // Tạo terrain
        function createTerrain() {
            updateLoading("Đang tạo địa hình...");
            
            // Tạo mặt đất
            const groundGeometry = new THREE.PlaneGeometry(200, 200, 50, 50);
            
            // Thêm độ cao ngẫu nhiên
            const vertices = groundGeometry.attributes.position.array;
            for (let i = 0; i < vertices.length; i += 3) {
                const x = vertices[i];
                const z = vertices[i + 2];
                const distance = Math.sqrt(x * x + z * z);
                const height = Math.sin(x * 0.1) * Math.cos(z * 0.1) * 2;
                vertices[i + 1] = height;
            }
            groundGeometry.computeVertexNormals();
            
            const groundMaterial = new THREE.MeshLambertMaterial({ 
                color: 0x3d7c47,
                side: THREE.DoubleSide 
            });
            
            terrain = new THREE.Mesh(groundGeometry, groundMaterial);
            terrain.rotation.x = -Math.PI / 2;
            terrain.receiveShadow = true;
            scene.add(terrain);
            
            // Thêm cỏ
            for (let i = 0; i < 100; i++) {
                const grassGeometry = new THREE.ConeGeometry(0.2, 1, 3);
                const grassMaterial = new THREE.MeshLambertMaterial({ color: 0x4caf50 });
                const grass = new THREE.Mesh(grassGeometry, grassMaterial);
                
                grass.position.set(
                    (Math.random() - 0.5) * 180,
                    0.5,
                    (Math.random() - 0.5) * 180
                );
                grass.rotation.x = Math.random() * Math.PI;
                scene.add(grass);
            }
            
            assetsLoaded++;
            updateLoadingBar();
        }
        
        // Tạo skybox
        function createSkybox() {
            updateLoading("Đang tạo bầu trời...");
            
            const skyGeometry = new THREE.SphereGeometry(500, 32, 32);
            const skyMaterial = new THREE.MeshBasicMaterial({
                color: 0x87ceeb,
                side: THREE.BackSide
            });
            
            skybox = new THREE.Mesh(skyGeometry, skyMaterial);
            scene.add(skybox);
            
            assetsLoaded++;
            updateLoadingBar();
        }
        
        // Tạo player
        function createPlayer() {
            updateLoading("Đang tạo nhân vật...");
            
            // Tạo nhóm player
            player = new THREE.Group();
            
            // Thân
            const bodyGeometry = new THREE.BoxGeometry(1, 2, 1);
            const bodyMaterial = new THREE.MeshLambertMaterial({ color: 0x3498db });
            const body = new THREE.Mesh(bodyGeometry, bodyMaterial);
            body.castShadow = true;
            player.add(body);
            
            // Đầu
            const headGeometry = new THREE.SphereGeometry(0.5, 16, 16);
            const headMaterial = new THREE.MeshLambertMaterial({ color: 0xf1c40f });
            const head = new THREE.Mesh(headGeometry, headMaterial);
            head.position.y = 1.5;
            head.castShadow = true;
            player.add(head);
            
            // Vũ khí
            const weaponGeometry = new THREE.BoxGeometry(0.2, 0.2, 1.5);
            const weaponMaterial = new THREE.MeshLambertMaterial({ color: 0x95a5a6 });
            const weapon = new THREE.Mesh(weaponGeometry, weaponMaterial);
            weapon.position.set(0.8, 0.5, 0);
            weapon.castShadow = true;
            player.add(weapon);
            
            // Thêm vào scene
            player.position.set(0, 3, 0);
            player.castShadow = true;
            scene.add(player);
            
            // Thêm camera follow
            camera.lookAt(player.position);
            
            assetsLoaded++;
            updateLoadingBar();
        }
        
        // Tạo quái vật
        function createEnemy() {
            const types = [
                { name: 'Goblin', color: 0xe74c3c, size: 0.8, hp: 30 },
                { name: 'Orc', color: 0x27ae60, size: 1.2, hp: 50 },
                { name: 'Skeleton', color: 0xecf0f1, size: 1.0, hp: 40 }
            ];
            
            const type = types[Math.floor(Math.random() * types.length)];
            
            // Tạo nhóm enemy
            const enemy = new THREE.Group();
            enemy.userData = {
                type: type.name,
                hp: type.hp,
                maxHP: type.hp,
                damage: 10,
                speed: 2,
                attacking: false,
                attackCooldown: 0
            };
            
            // Thân
            const enemyBodyGeometry = new THREE.BoxGeometry(type.size, type.size * 1.5, type.size);
            const enemyBodyMaterial = new THREE.MeshLambertMaterial({ color: type.color });
            const enemyBody = new THREE.Mesh(enemyBodyGeometry, enemyBodyMaterial);
            enemyBody.castShadow = true;
            enemy.add(enemyBody);
            
            // Đầu
            const enemyHeadGeometry = new THREE.SphereGeometry(type.size * 0.4, 16, 16);
            const enemyHeadMaterial = new THREE.MeshLambertMaterial({ 
                color: type.color === 0xecf0f1 ? 0xffffff : 0xf1c40f 
            });
            const enemyHead = new THREE.Mesh(enemyHeadGeometry, enemyHeadMaterial);
            enemyHead.position.y = type.size * 0.9;
            enemyHead.castShadow = true;
            enemy.add(enemyHead);
            
            // Vị trí ngẫu nhiên
            const angle = Math.random() * Math.PI * 2;
            const distance = 10 + Math.random() * 30;
            enemy.position.set(
                Math.cos(angle) * distance,
                2,
                Math.sin(angle) * distance
            );
            
            scene.add(enemy);
            enemies.push(enemy);
            
            return enemy;
        }
        
        // Tạo items (vàng, máu, mana)
        function createItems() {
            updateLoading("Đang tạo vật phẩm...");
            
            for (let i = 0; i < 20; i++) {
                const types = [
                    { type: 'gold', color: 0xffd700, size: 0.3 },
                    { type: 'health', color: 0xe74c3c, size: 0.4 },
                    { type: 'mana', color: 0x3498db, size: 0.4 }
                ];
                
                const itemType = types[Math.floor(Math.random() * types.length)];
                
                const geometry = new THREE.SphereGeometry(itemType.size, 16, 16);
                const material = new THREE.MeshLambertMaterial({ 
                    color: itemType.color,
                    emissive: itemType.color,
                    emissiveIntensity: 0.3
                });
                
                const item = new THREE.Mesh(geometry, material);
                item.userData = { type: itemType.type };
                
                // Vị trí ngẫu nhiên
                item.position.set(
                    (Math.random() - 0.5) * 180,
                    1,
                    (Math.random() - 0.5) * 180
                );
                
                item.castShadow = true;
                scene.add(item);
            }
            
            assetsLoaded++;
            updateLoadingBar();
        }
        
        // Thiết lập điều khiển
        function setupControls() {
            updateLoading("Đang thiết lập điều khiển...");
            
            // Điều khiển joystick cho mobile
            const joystickHandle = document.getElementById('joystickHandle');
            const joystickBase = document.querySelector('.joystick-base');
            let isDragging = false;
            
            joystickHandle.addEventListener('touchstart', (e) => {
                e.preventDefault();
                isDragging = true;
                joystickActive = true;
            });
            
            document.addEventListener('touchmove', (e) => {
                if (!isDragging) return;
                e.preventDefault();
                
                const touch = e.touches[0];
                const rect = joystickBase.getBoundingClientRect();
                const centerX = rect.left + rect.width / 2;
                const centerY = rect.top + rect.height / 2;
                
                let x = touch.clientX - centerX;
                let y = touch.clientY - centerY;
                
                // Giới hạn trong joystick
                const maxDistance = rect.width / 2 - 30;
                const distance = Math.sqrt(x * x + y * y);
                
                if (distance > maxDistance) {
                    x = (x / distance) * maxDistance;
                    y = (y / distance) * maxDistance;
                }
                
                // Cập nhật vị trí joystick
                joystickHandle.style.transform = `translate(${x}px, ${y}px)`;
                
                // Cập nhật vector di chuyển
                joystickVector.set(x / maxDistance, -y / maxDistance);
            });
            
            document.addEventListener('touchend', (e) => {
                if (isDragging) {
                    isDragging = false;
                    joystickActive = false;
                    joystickHandle.style.transform = 'translate(-50%, -50%)';
                    joystickVector.set(0, 0);
                }
            });
            
            // Điều khiển bàn phím cho desktop
            document.addEventListener('keydown', (e) => {
                keys[e.key.toLowerCase()] = true;
                
                if (e.key === ' ') { // Space để nhảy
                    playerJump();
                }
                if (e.key === 'h' || e.key === 'H') { // H để hồi phục
                    playerHeal();
                }
                if (e.key === 'n' || e.key === 'N') { // N để quái tiếp
                    createEnemy();
                }
            });
            
            document.addEventListener('keyup', (e) => {
                keys[e.key.toLowerCase()] = false;
            });
            
            // Điều khiển chuột
            renderer.domElement.addEventListener('click', (e) => {
                if (gameState.gameOver) return;
                playerAttack();
            });
            
            assetsLoaded++;
            updateLoadingBar();
        }
        
        // Thiết lập sự kiện
        function setupEventListeners() {
            updateLoading("Đang thiết lập sự kiện...");
            
            // Nút tấn công
            document.getElementById('attackBtn').addEventListener('touchstart', (e) => {
                e.preventDefault();
                playerAttack();
            });
            
            // Nút phép thuật
            document.getElementById('magicBtn').addEventListener('touchstart', (e) => {
                e.preventDefault();
                playerMagic();
            });
            
            // Nút nhảy
            document.getElementById('jumpBtn').addEventListener('touchstart', (e) => {
                e.preventDefault();
                playerJump();
            });
            
            // Nút hồi phục
            document.getElementById('healBtn').addEventListener('click', playerHeal);
            
            // Nút quái tiếp
            document.getElementById('nextEnemyBtn').addEventListener('click', () => {
                createEnemy();
                showNotification("Quái vật mới", "Một con quái vật mới đã xuất hiện!");
            });
            
            // Nút âm thanh
            document.getElementById('toggleSoundBtn').addEventListener('click', toggleSound);
            
            // Nút restart
            document.getElementById('restartBtn').addEventListener('click', restartGame);
            
            // Resize window
            window.addEventListener('resize', onWindowResize);
            
            assetsLoaded++;
            updateLoadingBar();
        }
        
        // Player di chuyển
        function updatePlayerMovement(deltaTime) {
            const speed = gameState.player.speed * deltaTime;
            const moveVector = new THREE.Vector3();
            
            // Điều khiển bàn phím (desktop)
            if (keys['w'] || keys['arrowup']) moveVector.z -= speed;
            if (keys['s'] || keys['arrowdown']) moveVector.z += speed;
            if (keys['a'] || keys['arrowleft']) moveVector.x -= speed;
            if (keys['d'] || keys['arrowright']) moveVector.x += speed;
            
            // Điều khiển joystick (mobile)
            if (joystickActive) {
                moveVector.x += joystickVector.x * speed;
                moveVector.z += joystickVector.y * speed;
            }
            
            // Áp dụng di chuyển
            player.position.add(moveVector);
            
            // Giới hạn di chuyển trong map
            player.position.x = Math.max(-95, Math.min(95, player.position.x));
            player.position.z = Math.max(-95, Math.min(95, player.position.z));
            
            // Cập nhật camera để follow player
            updateCamera();
            
            // Xoay player theo hướng di chuyển
            if (moveVector.length() > 0) {
                const angle = Math.atan2(moveVector.x, moveVector.z);
                player.rotation.y = angle;
            }
        }
        
        // Cập nhật camera
        function updateCamera() {
            // Camera follow player từ phía sau
            const cameraDistance = 10;
            const cameraHeight = 5;
            
            const cameraOffset = new THREE.Vector3(
                Math.sin(player.rotation.y) * cameraDistance,
                cameraHeight,
                Math.cos(player.rotation.y) * cameraDistance
            );
            
            camera.position.copy(player.position).add(cameraOffset);
            camera.lookAt(player.position);
        }
        
        // Player tấn công
        function playerAttack() {
            if (gameState.gameOver) return;
            
            // Tìm quái vật gần nhất
            let nearestEnemy = null;
            let nearestDistance = Infinity;
            
            enemies.forEach(enemy => {
                const distance = player.position.distanceTo(enemy.position);
                if (distance < 5 && distance < nearestDistance) {
                    nearestDistance = distance;
                    nearestEnemy = enemy;
                }
            });
            
            if (nearestEnemy) {
                // Gây damage
                const damage = gameState.player.damage;
                nearestEnemy.userData.hp -= damage;
                
                // Hiệu ứng tấn công
                createAttackEffect(player.position);
                
                // Kiểm tra quái vật chết
                if (nearestEnemy.userData.hp <= 0) {
                    enemyDefeated(nearestEnemy);
                } else {
                    // Quái vật bị tấn công
                    enemyReact(nearestEnemy);
                }
                
                // Cập nhật UI
                updateUI();
                showDamageEffect();
            }
        }
        
        // Player dùng phép
        function playerMagic() {
            if (gameState.gameOver || gameState.player.mana < 10) return;
            
            gameState.player.mana -= 10;
            
            // Tìm tất cả quái vật trong phạm vi
            enemies.forEach(enemy => {
                const distance = player.position.distanceTo(enemy.position);
                if (distance < 8) {
                    const damage = gameState.player.magicDamage;
                    enemy.userData.hp -= damage;
                    
                    // Hiệu ứng phép thuật
                    createMagicEffect(enemy.position);
                    
                    if (enemy.userData.hp <= 0) {
                        enemyDefeated(enemy);
                    } else {
                        enemyReact(enemy);
                    }
                }
            });
            
            updateUI();
        }
        
        // Player nhảy
        function playerJump() {
            // Kiểm tra player có đang trên mặt đất không
            if (player.position.y <= 3) {
                player.position.y += 8;
            }
        }
        
        // Player hồi phục
        function playerHeal() {
            if (gameState.player.mana >= 20 && gameState.player.hp < gameState.player.maxHP) {
                gameState.player.mana -= 20;
                gameState.player.hp = Math.min(gameState.player.maxHP, gameState.player.hp + 30);
                updateUI();
                createHealEffect(player.position);
            }
        }
        
        // Quái vật phản ứng
        function enemyReact(enemy) {
            enemy.userData.attacking = true;
            enemy.userData.attackCooldown = 1.0;
            
            // Di chuyển về phía player
            const direction = new THREE.Vector3();
            direction.subVectors(player.position, enemy.position).normalize();
            enemy.position.add(direction.multiplyScalar(enemy.userData.speed * 0.1));
            
            // Xoay về phía player
            const angle = Math.atan2(direction.x, direction.z);
            enemy.rotation.y = angle;
            
            // Tấn công player nếu đủ gần
            if (player.position.distanceTo(enemy.position) < 2) {
                gameState.player.hp -= enemy.userData.damage;
                updateUI();
                showDamageEffect();
                
                if (gameState.player.hp <= 0) {
                    gameOver();
                }
            }
        }
        
        // Quái vật bị tiêu diệt
        function enemyDefeated(enemy) {
            // Thưởng
            gameState.player.gold += 10;
            gameState.player.kills++;
            gameState.player.exp += 20;
            
            // Kiểm tra lên cấp
            if (gameState.player.exp >= gameState.player.expToNextLevel) {
                levelUp();
            }
            
            // Hiệu ứng tiêu diệt
            createExplosionEffect(enemy.position);
            
            // Xóa quái vật
            scene.remove(enemy);
            enemies = enemies.filter(e => e !== enemy);
            
            // Tạo quái vật mới sau 1-3 giây
            setTimeout(() => {
                if (!gameState.gameOver) {
                    createEnemy();
                }
            }, 1000 + Math.random() * 2000);
            
            updateUI();
        }
        
        // Lên cấp
        function levelUp() {
            gameState.player.level++;
            gameState.player.exp -= gameState.player.expToNextLevel;
            gameState.player.expToNextLevel = Math.floor(gameState.player.expToNextLevel * 1.5);
            
            // Tăng chỉ số
            gameState.player.maxHP += 20;
            gameState.player.hp = gameState.player.maxHP;
            gameState.player.maxMana += 10;
            gameState.player.mana = gameState.player.maxMana;
            gameState.player.damage += 5;
            gameState.player.magicDamage += 8;
            gameState.player.speed += 1;
            
            showNotification("LÊN CẤP!", `Bạn đã đạt cấp ${gameState.player.level}!`);
            createLevelUpEffect(player.position);
            updateUI();
        }
        
        // Game over
        function gameOver() {
            gameState.gameOver = true;
            showNotification("GAME OVER", `Bạn đã tiêu diệt ${gameState.player.kills} quái vật!`, true);
        }
        
        // Tạo hiệu ứng tấn công
        function createAttackEffect(position) {
            const geometry = new THREE.SphereGeometry(0.5, 8, 8);
            const material = new THREE.MeshBasicMaterial({ 
                color: 0xff9900,
                transparent: true,
                opacity: 0.8
            });
            
            const effect = new THREE.Mesh(geometry, material);
            effect.position.copy(position);
            effect.position.y += 2;
            scene.add(effect);
            
            // Animation
            let scale = 1;
            const animate = () => {
                scale += 0.1;
                effect.scale.setScalar(scale);
                material.opacity -= 0.05;
                
                if (material.opacity > 0) {
                    requestAnimationFrame(animate);
                } else {
                    scene.remove(effect);
                }
            };
            animate();
        }
        
        // Tạo hiệu ứng phép thuật
        function createMagicEffect(position) {
            const geometry = new THREE.IcosahedronGeometry(1, 0);
            const material = new THREE.MeshBasicMaterial({ 
                color: 0x9b59b6,
                wireframe: true,
                transparent: true,
                opacity: 0.7
            });
            
            const effect = new THREE.Mesh(geometry, material);
            effect.position.copy(position);
            effect.position.y += 2;
            scene.add(effect);
            
            let time = 0;
            const animate = () => {
                time += 0.1;
                effect.rotation.y = time;
                effect.rotation.x = time * 0.5;
                effect.scale.setScalar(1 + Math.sin(time) * 0.3);
                material.opacity -= 0.03;
                
                if (material.opacity > 0) {
                    requestAnimationFrame(animate);
                } else {
                    scene.remove(effect);
                }
            };
            animate();
        }
        
        // Tạo hiệu ứng hồi phục
        function createHealEffect(position) {
            for (let i = 0; i < 10; i++) {
                const geometry = new THREE.SphereGeometry(0.2, 8, 8);
                const material = new THREE.MeshBasicMaterial({ 
                    color: 0x2ecc71,
                    transparent: true,
                    opacity: 0.8
                });
                
                const particle = new THREE.Mesh(geometry, material);
                particle.position.copy(position);
                particle.position.y += 1;
                scene.add(particle);
                
                // Random direction
                const angle = Math.random() * Math.PI * 2;
                const speed = 0.05 + Math.random() * 0.1;
                const dx = Math.cos(angle) * speed;
                const dz = Math.sin(angle) * speed;
                
                let opacity = 0.8;
                const animate = () => {
                    particle.position.x += dx;
                    particle.position.z += dz;
                    particle.position.y += 0.1;
                    opacity -= 0.02;
                    material.opacity = opacity;
                    
                    if (opacity > 0) {
                        requestAnimationFrame(animate);
                    } else {
                        scene.remove(particle);
                    }
                };
                animate();
            }
        }
        
        // Tạo hiệu ứng nổ
        function createExplosionEffect(position) {
            for (let i = 0; i < 20; i++) {
                const geometry = new THREE.SphereGeometry(0.1, 4, 4);
                const material = new THREE.MeshBasicMaterial({ 
                    color: 0xff9900,
                    transparent: true,
                    opacity: 1
                });
                
                const particle = new THREE.Mesh(geometry, material);
                particle.position.copy(position);
                scene.add(particle);
                
                // Random direction và speed
                const angle = Math.random() * Math.PI * 2;
                const speed = 0.1 + Math.random() * 0.2;
                const dx = Math.cos(angle) * speed;
                const dz = Math.sin(angle) * speed;
                const dy = Math.random() * 0.2;
                
                let opacity = 1;
                const animate = () => {
                    particle.position.x += dx;
                    particle.position.z += dz;
                    particle.position.y += dy;
                    dy -= 0.01; // Gravity
                    opacity -= 0.05;
                    material.opacity = opacity;
                    
                    if (opacity > 0) {
                        requestAnimationFrame(animate);
                    } else {
                        scene.remove(particle);
                    }
                };
                animate();
            }
        }
        
        // Tạo hiệu ứng lên cấp
        function createLevelUpEffect(position) {
            const ringGeometry = new THREE.RingGeometry(1, 1.5, 32);
            const ringMaterial = new THREE.MeshBasicMaterial({ 
                color: 0xffd700,
                side: THREE.DoubleSide,
                transparent: true,
                opacity: 0.8
            });
            
            const ring = new THREE.Mesh(ringGeometry, ringMaterial);
            ring.position.copy(position);
            ring.position.y += 1;
            ring.rotation.x = Math.PI / 2;
            scene.add(ring);
            
            let time = 0;
            const animate = () => {
                time += 0.05;
                ring.scale.setScalar(1 + time);
                ringMaterial.opacity = 0.8 - time * 0.4;
                ring.rotation.z = time;
                
                if (ringMaterial.opacity > 0) {
                    requestAnimationFrame(animate);
                } else {
                    scene.remove(ring);
                }
            };
            animate();
        }
        
        // Cập nhật UI
        function updateUI() {
            // Cập nhật thanh máu
            const healthPercent = (gameState.player.hp / gameState.player.maxHP) * 100;
            document.getElementById('healthBar').style.width = `${healthPercent}%`;
            document.getElementById('healthText').textContent = `${gameState.player.hp}/${gameState.player.maxHP}`;
            document.getElementById('hpText').textContent = `${gameState.player.hp}/${gameState.player.maxHP}`;
            
            // Cập nhật mana
            const manaPercent = (gameState.player.mana / gameState.player.maxMana) * 100;
            document.getElementById('manaBar').style.width = `${manaPercent}%`;
            document.getElementById('manaText').textContent = `${gameState.player.mana}/${gameState.player.maxMana}`;
            
            // Cập nhật thông tin khác
            document.getElementById('levelText').textContent = gameState.player.level;
            document.getElementById('goldText').textContent = gameState.player.gold;
            document.getElementById('killText').textContent = gameState.player.kills;
        }
        
        // Hiệu ứng damage
        function showDamageEffect() {
            const effect = document.getElementById('damageEffect');
            effect.style.opacity = '0.5';
            
            setTimeout(() => {
                effect.style.opacity = '0';
            }, 200);
        }
        
        // Hiển thị thông báo
        function showNotification(title, text, showRestart = false) {
            document.getElementById('notificationTitle').textContent = title;
            document.getElementById('notificationText').textContent = text;
            document.getElementById('notification').style.display = 'block';
            
            if (showRestart) {
                document.getElementById('restartBtn').style.display = 'block';
            } else {
                document.getElementById('restartBtn').style.display = 'none';
                setTimeout(() => {
                    document.getElementById('notification').style.display = 'none';
                }, 2000);
            }
        }
        
        // Bật/tắt âm thanh
        function toggleSound() {
            gameState.soundEnabled = !gameState.soundEnabled;
            const btn = document.getElementById('toggleSoundBtn');
            btn.textContent = `Âm thanh: ${gameState.soundEnabled ? 'Bật' : 'Tắt'}`;
        }
        
        // Chơi lại
        function restartGame() {
            // Reset game state
            gameState = {
                player: {
                    hp: 100,
                    maxHP: 100,
                    mana: 50,
                    maxMana: 50,
                    level: 1,
                    gold: 0,
                    kills: 0,
                    exp: 0,
                    expToNextLevel: 100,
                    damage: 15,
                    magicDamage: 25,
                    speed: 5
                },
                enemies: [],
                gameOver: false,
                soundEnabled: true
            };
            
            // Xóa tất cả quái vật cũ
            enemies.forEach(enemy => scene.remove(enemy));
            enemies = [];
            
            // Reset player
            player.position.set(0, 3, 0);
            player.rotation.set(0, 0, 0);
            
            // Tạo quái vật mới
            for (let i = 0; i < 5; i++) {
                createEnemy();
            }
            
            // Cập nhật UI
            updateUI();
            
            // Ẩn thông báo
            document.getElementById('notification').style.display = 'none';
        }
        
        // Cập nhật loading
        function updateLoading(text) {
            document.getElementById('loadingText').textContent = text;
        }
        
        function updateLoadingBar() {
            const percent = (assetsLoaded / totalAssets) * 100;
            document.getElementById('loadingBar').style.width = `${percent}%`;
        }
        
        // Resize window
        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }
        
        // Game loop
        function animate() {
            requestAnimationFrame(animate);
            
            const deltaTime = Math.min(clock.getDelta(), 0.1);
            
            if (!gameState.gameOver) {
                // Cập nhật player
                updatePlayerMovement(deltaTime * 60);
                
                // Áp dụng gravity
                if (player.position.y > 3) {
                    player.position.y -= 0.5;
                }
                
                // Cập nhật quái vật
                enemies.forEach(enemy => {
                    if (enemy.userData.attackCooldown > 0) {
                        enemy.userData.attackCooldown -= deltaTime;
                    } else {
                        enemy.userData.attacking = false;
                    }
                    
                    // Quái vật di chuyển ngẫu nhiên
                    if (!enemy.userData.attacking && Math.random() < 0.01) {
                        enemy.userData.moveAngle = Math.random() * Math.PI * 2;
                    }
                    
                    if (enemy.userData.moveAngle !== undefined) {
                        const moveSpeed = enemy.userData.speed * deltaTime;
                        enemy.position.x += Math.cos(enemy.userData.moveAngle) * moveSpeed;
                        enemy.position.z += Math.sin(enemy.userData.moveAngle) * moveSpeed;
                        
                        // Giới hạn di chuyển
                        enemy.position.x = Math.max(-95, Math.min(95, enemy.position.x));
                        enemy.position.z = Math.max(-95, Math.min(95, enemy.position.z));
                    }
                });
            }
            
            // Render
            renderer.render(scene, camera);
        }
        
        // Bắt đầu game
        window.onload = init;
    </script>
</body>
</html>
